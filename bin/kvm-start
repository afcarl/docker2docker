#!/bin/sh
mknod /dev/kvm c 10 232
mkdir /dev/net
mknod /dev/net/tun c 10 200
ln -s /proc/mounts /etc/mtab
if ! [ -s boot2docker.hdd ]; then
    truncate --size 10G boot2docker.hdd
    yes | mkfs -t ext4 -L boot2docker-data boot2docker.hdd
fi
iptables -t nat -A POSTROUTING -s 172.18.0.0/24 -o eth0 -j MASQUERADE
socat TCP-LISTEN:22,fork,reuseaddr TCP:172.18.0.2:22 &
socat TCP-LISTEN:4243,fork,reuseaddr TCP:172.18.0.2:4243 &
exec kvm -nographic -m 512 -vnc :0 \
         -drive file=boot2docker.hdd,if=virtio \
         -cdrom boot2docker.iso \
         -device virtio-net,netdev=net0 -netdev tap,id=net0,script=/usr/local/bin/net-script,downscript=no
